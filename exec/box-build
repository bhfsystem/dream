#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  local json_var='{}'

  local nm_only

  if [[ "$#" == 0 ]]; then
    set -- virtualbox
  fi

  if [[ -n "${1:-}" ]]; then
    nm_only="$1"; shift
  fi

  case "$nm_only" in
    virtualbox|vmware|parallels)
      nm_only="${nm_only}-iso"
      true ;;
    digitalocean)
      true ;;
    "")
      true ;;
    "{"*)
      json_var="$nm_only"
      nm_only=
      ;;
    *)
      echo ERROR: "Invalid virtualization type: $nm_only" 1>&2
      return 1
      ;;
  esac

  case "${1:-}" in
    "{"*)
      json_var="$1"; shift
      ;;
  esac

  cd "$shome"
  local tmp_options="$(mktemp -t XXXXXX)"
  local tmp_ubuntu="$(mktemp -t XXXXXX)"
  jq -n --arg iso_path "$shome/iso" \
        --argfile ubuntu ubuntu1404.json '$ubuntu + { headless: "true", 
                                                      iso_path: $iso_path, 
                                                      ssh_username: "ubuntu",
                                                      docker: "true",
                                                      update: "true",
                                                      cpus: "2" }' > "$tmp_options"
  cat ubuntu.json | jq '.provisioners[].scripts = [
                                                      "script/update.sh",
                                                      "script/vagrant.sh",
                                                      "script/sshd.sh",
                                                      "script/vmware.sh",
                                                      "script/virtualbox.sh",
                                                      "script/parallels.sh",
                                                      "script/docker.sh",
                                                      "custom-script.sh",
                                                      "script/cleanup.sh" ]' | tee "$tmp_ubuntu"
  packer build${nm_only:+ -only="$nm_only"} -var-file "$tmp_options" "$tmp_ubuntu"
  rm -f "$tmp_options" "$tmp_ubuntu"
}

source sub "$0" "$@"
