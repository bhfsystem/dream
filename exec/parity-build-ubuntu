#!/usr/bin/env bash

function main {
  local shome="$(cd -P -- "${BASH_SOURCE%/*}/.." && pwd -P)"

  local json_var='{}'

  local nm_packer_builder="$VAGRANT_DEFAULT_PROVIDER"
  local nm_provider
  local nm_region=
  local nm_snapshot=
  local nm_vm="ubuntu1404"
  local secret_key=
  local access_key=
  local image_id=
  local instance_type=
  local fl_docker="true"


  case "$nm_packer_builder" in
    vmware_fusion|vmware_desktop)
      nm_provider="vmware_desktop"
      nm_packer_builder="vmware-iso"
      ;;

    virtualbox)
      nm_provider="${nm_packer_builder}"
      nm_packer_builder="${nm_packer_builder}-iso"
      ;;

    docker)
      fl_docker="false"
      nm_provider='docker'
      nm_packer_builder='docker'
      ;;

    aws)
      nm_provider="${nm_packer_builder}"
      nm_packer_builder="amazon-ebs"

      if [[ "$#" -gt 0 ]]; then
        nm_region="$1"; shift
      fi
      : ${nm_region:=${AWS_DEFAULT_REGION:-us-west-1}}

      nm_vm="${nm_vm}-${nm_region}"
      access_key="$AWS_ACCESS_KEY"
      secret_key="$AWS_SECRET_KEY"
      nm_snapshot="packer-${nm_region}-$(date +%s)"

      if [[ "$#" -gt 0 ]]; then
        image_id="$1"; shift
      else
        local ap_northeast_1=ami-d886a1b6
        local ap_southeast_1=ami-a17dbac2
        local ap_southeast_2=ami-067d2365
        local eu_central_1=ami-99cad9f5
        local eu_west_1=ami-a317ced0
        local sa_east_1=ami-ae44ffc2
        local us_east_1=ami-f7136c9d
        local us_west_1=ami-44b1de24
        local us_west_2=ami-46a3b427

        eval image_id="\$${nm_region//-/_}"
      fi

      if [[ "$#" -gt 0 ]]; then
        instance_type="$1"; shift
      else
        instance_type='c4.large'
      fi
      ;;

    digitalocean|digital_ocean)
      nm_packer_builder='digitalocean'
      nm_provider="${nm_packer_builder}"

      if [[ "$#" -gt 0 ]]; then
        nm_region="$1"; shift
      fi
      : ${nm_region:=${DIGITALOCEAN_DEFAULT_REGION:-sfo1}}

      nm_vm="${nm_vm}-${nm_region}"
      secret_key="$DIGITALOCEAN_API_TOKEN"
      nm_snapshot="packer-${nm_region}-$(date +%s)"

      if [[ "$#" -gt 0 ]]; then
        image_id="$1"; shift
      else
        image_id='ubuntu-14-04-x64'
      fi

      if [[ "$#" -gt 0 ]]; then
        instance_type="$1"; shift
      else
        instance_type='2gb'
      fi
      ;;

    "")
      true ;;

    "{"*)
      json_var="$nm_packer_builder"
      nm_packer_builder=
      ;;

    *)
      echo ERROR: "Invalid virtualization type: $nm_provider" 1>&2
      return 1
      ;;
  esac

  case "${1:-}" in
    "{"*)
      json_var="$1"; shift
      ;;
  esac

  local tmp_ubuntu="$(mktemp -t XXXXXX)"
  cat "packer.json" | jq \
    --arg provider "$nm_provider" '.provisioners[].scripts = 
    [ "script/first.sh",
      "script/update.sh",
      "script/sshd.sh",
      "script/ubuntu.sh",
      "script/\($provider).sh",
      "script/install-docker.sh",
      "custom-script.sh",
      "script/cleanup.sh",
      "script/last.sh" ]' | tee "$tmp_ubuntu"

  local tmp_options="$(mktemp -t XXXXXX)"
  jq -n \
    --arg iso_path "$shome/iso" \
    --arg secret_key "$secret_key" \
    --arg access_key "$access_key" \
    --arg provider "$nm_provider" \
    --arg region "$nm_region" \
    --arg vm_name "$nm_vm" \
    --arg snapshot_name "$nm_snapshot" \
    --arg image_id "$image_id" \
    --arg instance_type "$instance_type" \
    --arg docker "$fl_docker" \
    '{  headless: "true", 
        iso_path: $iso_path, 
        ssh_username: "ubuntu",
        docker: $docker,
        update: "true",
        access_key: $access_key,
        secret_key: $secret_key,
        provider: $provider,
        region: $region,
        snapshot_name: $snapshot_name,
        vm_name: $vm_name,
        image_id: $image_id,
        instance_type: $instance_type,
        cpus: "2" }' | tee "$tmp_options"

  packer build${nm_packer_builder:+ -only="$nm_packer_builder"} -var-file "$tmp_options" "$tmp_ubuntu"
  rm -f "$tmp_options" "$tmp_ubuntu"
}

source sub "$0" "$@"
